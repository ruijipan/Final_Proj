---
title: "Introduction"
output: 
  html_document:
    toc: true
    toc_float: true

---

## Motivation

New to New York City, our group members are all shocked by the high cost of building rentals. This encourages us to explore more about the property market and the buildings' price in NYC.

We are curious about the distribution of buildings of each pricing level in time and geographical zones. Also, we want to find factors that may have influence on buildings value. Based on which, we can further modeling and predicting the buildings price in New York.

## Planned Analysis

We plan to conduct following work in our project: 

- Preprocessing: Data cleaning and transforamtion.
- Exploratory Analysis: Include visualization of a single variable and relationship between variables.
- Statistical Analysis: Based on hypothesis testing to find factors that may have influence on the buildings' marked value.
- Modeling: Predicting building's value based 
- Project our findings to interactive webpage.


## Data Source

### Cooperative Comparable Rental Income

To attain the price information of buildings, we use the dataset published by the Department of Finance of NYC. The origin data can be acquired from [NYC Open Data](https://data.cityofnewyork.us/City-Government/DOF-Cooperative-Comparable-Rental-Income-Citywide-/myei-c3fa)

This dataset contains the income and expense statements of condominium and comparable rental buildings in NYC that helps people estimate the marked value of their own buildings. In each observations, a condominium/cooperative is compared with three rental buildings that have similar physical and geographical features.  We equaly treat these two kind of buildings and transformed the data shape to ensure that each observation records exactly one building.

### ?

### ? 





```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(plotly)
library(patchwork)

#load("E:/2023_autumn/DataScience/Final_Proj/data/cleaned_data.RData")
# why?
load("data/cleaned_data.RData")
transformed_rental_income=
  transformed_rental_income %>%
  separate(boro_block_lot, into = c("borough", "block", "lot"), sep = "-") %>%
  mutate(
  borough = case_when(
    borough == "1" ~ "Manhattan",
    borough == "2" ~ "Bronx",
    borough == "3" ~ "Brooklyn",
    borough == "4" ~ "Queens",
    borough == "5" ~ "Staten Island")
  ) 
```

## Observations and Variables

After cleaning, our dataset have `r nrow(transformed_rental_income)` observations and `r ncol(transformed_rental_income)` variables. These observations are reported from 2012 to 2021 and covering the 5 boroughs of NYC.

```{r message=FALSE, warning=FALSE}
transformed_rental_income %>% 
  mutate(borough = fct_reorder(borough, full_market_value)) %>% 
  group_by(borough) %>%
  summarise(
    observations = n()
  ) %>%
  plot_ly(x = ~borough, y = ~observations, color = ~borough, type = "bar", colors = "viridis") %>%
  layout(title = 'Records in each Borough')
```
address to lat and long

```{r eval=FALSE}
Manhattan_data = transformed_rental_income %>%
  filter(
    borough == "Manhattan"
  ) %>% 
  group_by(address) %>%
  summarise(
    times = n()
  ) %>%
  mutate(
    address = paste(address,"Manhattan",sep = ",")
  )

Manhattan_data$latlona = map(.x = Manhattan_data$address, ~ geocode(.x, output = "latlona", source = "google"))
save(Manhattan_data, file = "data/Manhattan_latlonmap.RData")

#

#load("E:/2023_autumn/DataScience/Final_Proj/data/Manhattan_latlonmap.RData")
#again?
load("data/Manhattan_latlonmap.RData")


colnames(Manhattan_data) = c("address1","times","latlona")
Manhattan_data = Manhattan_data %>%
  unnest(cols = latlona) %>%
  select(-address)
colnames(Manhattan_data) = c("address","times","lon","lat")
save(Manhattan_data, file = "data/Manhattan_latlonmap.RData")
```

```{r message=FALSE, warning=FALSE}
#load("E:/2023_autumn/DataScience/Final_Proj/data/Manhattan_latlonmap.RData")
# again
load("data/Manhattan_latlonmap.RData")

```

Some key variables are as follows:

- `Gross SqFt`: Gross square footage of the building
- `Estimated` Gross Income: Estimated Income per SquareFoot * Gross SquareFoot
- `Income per SqFt`: Estimated income per squarefoot of median comparable
- `Estimated Expense`: Estimated Expense per SquareFoot * Gross SquareFoot
- `Expense per SqFt`: Estimated expense per squarefoot of median comparab
- `Net Operating Income`: Estimated Gross Income-Estimated Expense
- `Full Market Value`: Current yearâ€™s total market value of the land and building
- `Market Value per SqFt`: Full Market Value/ Gross SquareFoot

```{r}

```


```{r message=FALSE, warning=FALSE}
box_value =  transformed_rental_income %>% 
  mutate(borough = fct_reorder(borough, full_market_value)) %>% 
  plot_ly(y = ~log(full_market_value), color = ~borough, type = "box", colors = "viridis") %>%
  layout(
    xaxis = list(title = 'Borough'),
    yaxis = list(title = 'log(Market value)')
  )


line_value_year = transformed_rental_income %>% 
  mutate(borough = fct_reorder(borough, full_market_value)) %>% 
  group_by(borough,report_year) %>% 
  summarise(mean_market_value = mean(full_market_value)) %>%
  plot_ly(x = ~ report_year, y = ~ mean_market_value, color = ~borough, type = "scatter",mode = 'lines', colors = "viridis",showlegend = F) %>%
  layout(
    xaxis = list(title = 'Year'),
    yaxis = list(title = 'Mean Market value')
  )


subplot(box_value, line_value_year, nrows = 2, titleY = TRUE, titleX = TRUE, margin = 0.1)
```

